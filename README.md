# 申万一级行业趋势阶段分析

基于温斯坦（Stan Weinstein）34 周均线阶段分析法，对 A 股 31 个申万一级行业（2021 版）进行趋势阶段判断，帮助识别各行业当前处于熊市、牛市还是转换期。

## 核心方法

以 34 周简单移动平均线（MA34）为中轴，将行业趋势划分为四个阶段：

| 阶段 | 名称 | 特征 |
|------|------|------|
| Stage 1 | 熊市 | 价格持续在 MA34 下方，均线下行，反弹受压 |
| Stage 2 | 熊牛转换 | 价格围绕 MA34 反复争夺，均线走平，量能回升 |
| Stage 3 | 牛市 | 价格稳定在 MA34 上方，均线上行，回踩获支撑 |
| Stage 4 | 牛熊转换 | 价格围绕 MA34 争夺，均线由升转平，支撑失效 |

**核心策略**：买在第二阶段尾声（放量突破确认），卖在第四阶段（支撑失效确认）。

### 状态机模型

采用有限状态机（FSM）控制阶段转换，防止信号频繁跳变（Whipsaw）。只允许以下合法转换路径：

```
    ┌──────────────────────────────────────────────┐
    │                                              │
    ▼                                              │
 Stage 1 ──→ Stage 2 ──→ Stage 3 ──→ Stage 4 ──→ ┘
 (熊市)      (熊牛转换)    (牛市)      (牛熊转换)
              │  ▲                      │  ▲
              │  │                      │  │
              ▼  │                      ▼  │
           Stage 1                   Stage 3
          (底部失败)               (假跌破修复)
```

#### 转换条件

| 路径 | 条件 | 说明 |
|------|------|------|
| 2 → 3 严格突破 | 价格 > MA34×(1+α) + 斜率上行 + 量比 ≥ 1.5x | 标准放量突破 |
| 2 → 3 持续性突破 | 连续 ≥ 8 周站上 MA34 + 价格 > MA34×(1+α) + 支撑守住 | 不要求放量，适用于温和上涨 |
| 4 → 1 崩盘 | 价格 < MA34×(1-α) + 斜率下行 | 确认趋势反转 |
| 4 → 3 严格修复 | 价格 > MA34×(1+α) + 斜率上行 + 量比 ≥ 1.5x | 放量确认假跌破 |
| 4 → 3 持续性恢复 | 连续 ≥ 8 周站上 MA34 + 价格 > MA34×(1+α) + 支撑守住 | 不要求放量，适用于缓慢修复 |
| 2 → 1 失败回落 | 价格 < MA34×(1-α) + 斜率下行 | 底部构筑失败 |

> α 为自适应阈值，由 ATR 动态计算（见下文）。

### 硬性规则

- 连续 **4 周**收盘价在 MA34 下方 + MA 斜率下行 → 强制判定为 Stage 1（熊市）
- 连续 **2 周**收盘价跌破 MA34 → 排除 Stage 3（不可能在牛市）

## ATR 自适应阈值

### 问题

固定阈值（α=5%, slope_flat=1.5%, support_tolerance=2%）对不同波动特征的行业"一刀切"。例如：

- **银行**（ATR% ~3.3%）：低波动，固定 5% 阈值过松，需要很大偏离才触发判定
- **传媒**（ATR% ~5.5%）：高波动，固定 5% 阈值过紧，正常波动即触发误判

两者波动差异近 2 倍，同一套阈值无法兼顾。

### 方案

引入 14 周 ATR（Average True Range）作为波动率基准，将关键阈值从固定常量改为逐行动态计算：

```
atr_pct = ATR14 / MA34              # 归一化波动率
adaptive_alpha = 1.0 × atr_pct      # 价格偏离阈值
adaptive_slope_flat = 0.3 × atr_pct  # 斜率走平阈值
adaptive_support_tol = 0.4 × atr_pct # 支撑/压力容忍度
```

系数来源：固定阈值 ÷ 全行业 ATR% 中位数（≈ 0.047），使中位数行业的自适应值与原固定值一致。

### 效果

| 行业 | ATR% | adaptive_alpha | 对比固定 5% |
|------|------|----------------|-------------|
| 银行 | ~3.3% | ~3.3% | 更灵敏，更早捕捉趋势变化 |
| 传媒 | ~5.5% | ~5.5% | 更宽容，减少假信号 |
| 中位数行业 | ~4.7% | ~4.7% | 与原固定阈值基本一致 |

### ATR 计算

```
TR = max(High - Low, |High - PrevClose|, |Low - PrevClose|)
ATR14 = SMA(TR, 14)
```

ATR14 在 `generate_weekly_kline()` 流程中随 MA34、MA 斜率一起计算，作为周 K 线的标准输出列。

## 交易信号

系统在 Stage 2（熊牛转换）和 Stage 4（牛熊转换）中检测细粒度信号，帮助判断趋势突破或崩盘的进展。

> 以下公式中：`α` = adaptive_alpha（ATR 自适应），`β` = adaptive_slope_flat（ATR 自适应），`VolRatio` = 4 周均量 / 10 周均量，`price_pos` = (close - MA34) / MA34，`ma_slope` = MA34 的 4 周变化率。

### 利好信号（标注在 K 线下方）

#### 1. 接近突破 `approaching_breakout`

底部转换期的早期积极信号，价格首次尝试站上均线。

**前置条件**：当前处于 Stage 2（熊牛转换），且此前未出现过未消耗的"接近突破"信号。

**触发条件**（全部满足）：

- `price_pos > 0` — 收盘价站上 MA34
- `ma_slope >= 0` — 均线斜率不再下行（走平或上行）
- 同时**不满足**完整突破的全部三项条件，即以下至少一项不成立：
  - `price_pos > α`（偏离不够显著）
  - `ma_slope > β`（斜率不够陡峭）
  - `VolRatio >= 1.5`（量能不足）

**含义**：价格试探性突破均线，但力度不够（量、速度、幅度至少缺一项），突破尚未确认。需关注后续能否放量跟进。

---

#### 2. 确认突破 `breakout_confirmed`

牛市正式确立的确认信号。**买入信号。**

**前置条件**：上一周处于 Stage 2，本周状态机判定转入 Stage 3。

**触发条件**（满足以下任一路径即可完成 2→3 转换）：

**路径 A — 严格放量突破**（全部满足）：
- `price_pos > α` — 价格显著站上 MA34
- `ma_slope > β` — 均线明确拐头向上
- `VolRatio >= 1.5` — 成交量放大至均量 1.5 倍

**路径 B — 持续性突破**（全部满足）：
- `consecutive_above_ma >= 8` — 连续 8 周以上收盘价在 MA34 上方
- `price_pos > α` — 价格显著站上 MA34
- `support_held = True` — 近 4 周最低点守住 MA34 支撑

**路径 C — 宽松放量突破**（全部满足）：
- `bull_score > bottom_score × 1.5` — 牛市评分显著高于底部评分
- `price_pos > α` — 价格显著站上 MA34
- `ma_slope > β` — 均线拐头向上
- `VolRatio >= 1.2` — 成交量放大至均量 1.2 倍（低于严格标准）

**含义**：趋势由底部震荡正式进入上升通道。三条路径覆盖不同突破形态：爆发性放量突破、温和持续上涨、以及介于两者之间的中等强度突破。

---

#### 3. 假崩盘 `breakdown_failed`

牛熊转换期的一次下跌被证明是假动作。

**前置条件**：当前处于 Stage 4，且此前已出现过"接近崩盘"信号（标记为活跃状态）。

**触发条件**：

- `price_pos > 0` — 价格重新站回 MA34 上方

**含义**：之前跌破均线被认为是"接近崩盘"，但本周价格重返均线上方，说明空头力量不足，下跌只是假动作。短期利好，但仍处于 Stage 4，需持续观察。

---

#### 4. 修复回牛 `bull_recovery`

牛熊转换期结束，趋势重新回到牛市。

**前置条件**：上一周处于 Stage 4，本周状态机判定转回 Stage 3。

**触发条件**（满足以下任一路径即可完成 4→3 转换）：

**路径 A — 严格放量修复**（全部满足）：
- `price_pos > α` — 价格显著站上 MA34
- `ma_slope > β` — 均线恢复上行
- `VolRatio >= 1.5` — 放量确认

**路径 B — 持续性恢复**（全部满足）：
- `consecutive_above_ma >= 8` — 连续 8 周以上收盘价在 MA34 上方
- `price_pos > α` — 价格显著站上 MA34
- `support_held = True` — 近 4 周最低点守住支撑

**含义**：此前的牛熊转换被证伪。原本的"顶部信号"只是上升途中的正常回调或震荡，趋势恢复上行。

---

### 利空信号（标注在 K 线上方）

#### 5. 接近崩盘 `approaching_breakdown`

牛熊转换期的早期危险信号，价格首次跌破均线。

**前置条件**：当前处于 Stage 4（牛熊转换），且此前未出现过未消耗的"接近崩盘"信号。

**触发条件**（全部满足）：

- `price_pos < 0` — 收盘价跌破 MA34
- `ma_slope <= 0` — 均线斜率不再上行（走平或下行）
- 同时**不满足**完整崩盘的全部两项条件，即以下至少一项不成立：
  - `price_pos < -α`（跌幅不够深）
  - `ma_slope < -β`（下行速度不够快）

**含义**：价格跌破均线支撑，但跌幅或均线下行速度尚不足以确认趋势反转。需要警惕，但崩盘未最终确认。

---

#### 6. 确认崩盘 `breakdown_confirmed`

熊市正式确立的确认信号。**卖出 / 离场信号。**

**前置条件**：上一周处于 Stage 4，本周状态机判定转入 Stage 1。

**触发条件**（满足以下任一路径即可完成 4→1 转换）：

**路径 A — 标准崩盘**（全部满足）：
- `price_pos < -α` — 价格显著跌破 MA34
- `ma_slope < -β` — 均线明确拐头向下

**路径 B — 宽松崩盘**（全部满足）：
- `bear_score > top_score × 1.3` — 熊市评分显著高于牛熊转换评分
- `price_pos < -α` — 价格显著跌破 MA34

**路径 C — 硬性规则强制**（全部满足）：
- `consecutive_below_ma >= 4` — 连续 4 周收盘价在 MA34 下方
- `ma_slope < -β` — 均线下行

**含义**：趋势由顶部震荡正式进入下跌通道。路径 C 为无条件硬规则，无论前一状态是什么，连续 4 周跌破 + 斜率下行即强制进入熊市。

---

#### 7. 假突破 `breakout_failed`

底部转换期的一次上攻被证明是假突破。

**前置条件**：当前处于 Stage 2，且此前已出现过"接近突破"信号（标记为活跃状态）。

**触发条件**：

- `price_pos < 0` — 价格重新跌回 MA34 下方

**含义**：之前站上均线被认为是"接近突破"，但本周价格跌回均线下方，说明多头力量不足，上攻只是假动作。短期利空，继续底部震荡。

---

#### 8. 回落熊市 `bear_fallback`

底部构筑彻底失败，趋势重新进入熊市。

**前置条件**：上一周处于 Stage 2，本周状态机判定退回 Stage 1。

**触发条件**（满足以下任一路径即可完成 2→1 转换）：

**路径 A — 标准回落**（全部满足）：
- `price_pos < -α` — 价格显著跌破 MA34
- `ma_slope < -β` — 均线恢复下行

**路径 B — 硬性规则强制**（全部满足）：
- `consecutive_below_ma >= 4` — 连续 4 周收盘价在 MA34 下方
- `ma_slope < -β` — 均线下行

**含义**：此前的底部整理只是下跌中继，趋势重新恶化。Stage 2 构筑的"底部"被击穿。

---

### 信号生命周期

```text
                 Stage 2 内部                                Stage 4 内部
          ┌──────────────────────┐                    ┌──────────────────────┐
          │                      │                    │                      │
  价格站上MA34  ──→ 接近突破         │            价格跌破MA34  ──→ 接近崩盘         │
          │       │              │                    │       │              │
          │   价格跌回MA34下方       │                    │   价格站回MA34上方       │
          │       │              │                    │       │              │
          │       ▼              │                    │       ▼              │
          │     假突破            │                    │     假崩盘            │
          │                      │                    │                      │
          └──────────────────────┘                    └──────────────────────┘
                    │                                           │
       ┌────────────┼────────────┐              ┌──────────────┼──────────────┐
       ▼            ▼            ▼              ▼              ▼              ▼
   确认突破      回落熊市    继续震荡       修复回牛        确认崩盘       继续震荡
   (→ S3)       (→ S1)     (留 S2)       (→ S3)         (→ S1)        (留 S4)
```

### 信号使用建议

| 信号类型 | 信号 | 操作建议 |
|----------|------|----------|
| 预警信号 | 接近突破 / 接近崩盘 | 提示关注，不宜直接操作。可开始制定后续计划 |
| 确认信号 | 确认突破 / 确认崩盘 | 可作为买卖决策的核心参考依据 |
| 反转信号 | 假突破 / 假崩盘 | 前一次尝试失败，趋势未改变。调整预期，继续观察 |
| 回退信号 | 修复回牛 / 回落熊市 | 转换期判断被推翻，趋势恢复。重新评估持仓策略 |

## 量化指标

| 指标 | 计算方式 | 用途 |
|------|----------|------|
| 价格偏离度 | (close - MA34) / MA34 | 判断价格与均线的相对位置（阈值由 ATR 自适应） |
| MA34 斜率 | 4 周内 MA34 的变化率 | 判断均线趋势方向（走平阈值由 ATR 自适应） |
| ATR14 | 14 周真实波幅均值 | 衡量行业波动率，驱动自适应阈值 |
| 穿越频率 | 8 周内价格穿越 MA34 的次数 | 区分争夺期（>=2次）与单边期 |
| 成交量比 | 4 周均量 / 10 周均量 | 判断市场活跃度 |
| 支撑确认 | 近4周最低点 > MA34 × (1 - tolerance) | 牛市中回踩是否守住支撑（tolerance 由 ATR 自适应） |
| 压力确认 | 近4周最高点 < MA34 × (1 + tolerance) | 熊市中反弹是否被均线压制（tolerance 由 ATR 自适应） |
| 突破放量 | 成交量比 >= 1.5 | 阶段突破信号的量能确认 |

## 参数配置

### 基础参数（固定）

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `price_position_threshold` | 5% | 价格偏离 MA34 的显著性阈值（ATR 缺失时的 fallback） |
| `slope_flat_threshold` | 1.5% | MA 斜率"走平"判定阈值（ATR 缺失时的 fallback） |
| `support_tolerance` | 2% | 支撑/压力的容忍度（ATR 缺失时的 fallback） |
| `crossover_window` | 8 周 | 穿越频率统计窗口 |
| `crossover_threshold` | 2 次 | "反复争夺"的穿越次数阈值 |
| `breakout_volume_threshold` | 1.5x | 突破时的放量确认倍数 |
| `support_window` | 4 周 | 支撑/压力确认的回看窗口 |

### ATR 自适应系数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `atr_alpha_multiplier` | 1.0 | adaptive_alpha = 系数 × atr_pct |
| `atr_slope_multiplier` | 0.3 | adaptive_slope_flat = 系数 × atr_pct |
| `atr_support_multiplier` | 0.4 | adaptive_support_tol = 系数 × atr_pct |
| `recovery_sustain_weeks` | 8 周 | 持续性恢复/突破路径要求的连续站稳周数 |

## 项目结构

```
industry-trend/
├── main.py              # CLI 入口
├── app.py               # Streamlit Web 仪表板
├── requirements.txt     # Python 依赖
├── config/
│   └── industries.py    # 31 个申万一级行业代码和名称
├── src/
│   ├── scraper.py       # 数据采集（Playwright 自动化浏览器）
│   ├── kline.py         # 日K → 周K 转换 + MA34 + ATR14 计算
│   └── stage_analyzer.py # 四阶段状态机判断算法 + ATR 自适应阈值
└── data/
    ├── daily/           # 日K线 CSV（按行业存储）
    └── xls/             # 原始下载的 XLS 文件
```

## 安装

```bash
# 安装 Python 依赖
pip install -r requirements.txt

# 安装 Playwright 浏览器（数据下载需要）
playwright install chromium
```

## 使用方法

### 1. 下载数据

从申万研究所网站下载全部 31 个行业的历史行情数据：

```bash
python main.py download
```

添加 `--no-headless` 可显示浏览器窗口：

```bash
python main.py download --no-headless
```

### 2. 分析行业阶段

对已下载的数据运行阶段分析，在终端输出结果：

```bash
python main.py analyze
```

输出示例：

```
================================================================================
申万一级行业趋势阶段分析（基于34周均线）
================================================================================

阶段分布:
  Stage 1 熊市: 1 个行业
  Stage 2 熊牛转换: 3 个行业
  Stage 3 牛市: 22 个行业
  Stage 4 牛熊转换: 5 个行业

行业名称         代码         阶段    置信度      收盘价      MA34     偏离度   MA斜率
--------------------------------------------------------------------------------
银行         801780      S1 熊市   0.90   3883.56   4189.75   -7.3%      ↓
基础化工     801030      S3 牛市   0.65   5163.81   4200.32  +22.9%      ↑
...
```

### 3. 下载 + 分析一步完成

```bash
python main.py all
```

### 4. 启动 Web 仪表板

```bash
streamlit run app.py
```

浏览器访问 `http://localhost:8501`，仪表板包含：

- **阶段分布概览**：柱状图展示各阶段行业数量
- **行业汇总表**：支持按阶段筛选、按列排序
- **周K线详情图**：交互式蜡烛图 + MA34 均线，背景色标注阶段区间，交易信号箭头标注
- **阶段转换历史**：记录各行业阶段切换的时间节点
- **刷新数据按钮**：一键重新下载并分析

## 数据来源

[申万宏源研究所](https://www.swsresearch.com/institute_sw/allIndex/analysisIndex) — 申万一级行业指数历史行情数据（1999 年至今）。
