# Weinstein 行业轮动策略 — 回测说明

## 策略概述

本策略基于温斯坦（Weinstein）34周均线阶段分析法，利用状态机产生的**确认突破**和**确认崩盘**信号，在申万行业之间进行轮动配置。支持一级行业（31个）和二级行业（124个）。

核心思路：跟踪行业趋势变化，买入进入牛市阶段的行业，卖出进入熊市阶段的行业。

## 信号定义

### 确认突破（breakout_confirmed）— 买入信号

当行业从 **Stage 2（熊牛转换）** 进入 **Stage 3（牛市）** 时触发。

触发条件（满足任一路径）：
- **路径A（标准突破）**：价格偏离度 > alpha 且 MA斜率 > slope_flat 且 成交量比 >= 1.5
- **路径B（持续突破）**：连续站稳MA34达8周 且 价格偏离度 > alpha 且 支撑守住
- **路径C（宽松突破）**：牛市评分 > 底部评分×1.5 且 价格偏离度 > alpha 且 MA斜率 > slope_flat 且 成交量比 >= 1.2

### 确认崩盘（breakdown_confirmed）— 卖出信号

当行业从 **Stage 4（牛熊转换）** 进入 **Stage 1（熊市）** 时触发。

触发条件（满足任一路径）：
- **路径A（标准崩盘）**：价格偏离度 < -alpha 且 MA斜率 < -slope_flat
- **路径B（宽松崩盘）**：熊市评分 > 顶部评分×1.3 且 价格偏离度 < -alpha

## 仓位管理规则

| 参数 | 默认值 | 说明 |
| ---- | ------ | ---- |
| 初始资金 | 10,000 | 回测起始资金 |
| 最大持仓数 | 5 | 同时持有行业的上限（可通过 Web 页面调整） |
| 单仓比例 | 1/最大持仓数 | 每个行业的目标仓位占比（试探仓30% + 确认加仓70%） |
| 同一级行业上限 | 3 | 同一个一级行业下最多持仓的二级行业数 |

### 买入逻辑（分批建仓）

采用**试探仓 + 确认加仓**的两步建仓策略，降低假突破带来的损失：

#### 第一步：接近突破 → 试探买入30%

1. 当某行业出现**接近突破**（approaching_breakout）信号且未持仓 → 买入**30%仓位**
2. 买入金额 = 当前总资产 × 单仓比例 × 30%
3. 仅在有空闲仓位时执行（不触发满仓替换）
4. 标记为试探仓（is_partial = True）

#### 第二步：假突破 → 卖出试探仓

1. 当试探仓行业**连续 2 周收盘价低于 MA34** → 判定假突破，卖出试探仓
2. 仅对试探仓（is_partial = True）生效

#### 第三步：确认突破 → 加仓70%

1. 当持仓行业出现**确认突破**（breakout_confirmed）信号：
   - 若已有试探仓 → 加仓**70%**，更新加权平均成本价，标记为满仓
   - 若无试探仓（直接突破） → 一次性买入**100%仓位**（保留满仓替换逻辑）
2. 加仓金额 = 当前总资产 × 单仓比例 × 70%

### 卖出逻辑

1. 当持仓行业出现**确认崩盘**信号 → 全部卖出该行业持仓

### 强制卖出规则

除确认崩盘信号外，以下情形也会触发强制卖出，用于在状态机尚未确认崩盘时及时止损：

#### 规则1：ATR波动率止损（force_sell_atr_stop）

- **条件**：当周收盘价 < 前8周最低收盘价 - 3 × ATR14
- **逻辑**：基于波动率的动态止损，以近期价格底部为基准，波动大的行业止损距离更宽，波动小的行业止损更紧
- **数据来源**：`weekly_df["close"].rolling(8).min().shift(1) - 3.0 * weekly_df["atr14"]`

### 满仓替换逻辑

当已持仓达上限，且出现新的确认突破信号时：

1. 将所有候选（现有持仓 + 新信号行业）按**历史ATR%（股性/弹性）** 降序排列
2. 历史ATR% = 全部历史 `atr14 / close` 的中位数，值越大说明该行业波动弹性越强、潜在上涨空间越大
3. 贪心选择：从高到低逐一选入，遵守以下约束：
   - 总持仓数不超过最大持仓数
   - 同一级行业下最多持仓 3 个二级行业
4. 未被选中的现有持仓被卖出（reason = `replaced_weakest`），被选中的新候选执行买入

### 行业分散约束

针对二级行业回测，限制同一个一级行业下最多持仓 **3 个**二级行业，避免过度集中于单一板块：

- **适用范围**：approaching_breakout 试探买入、breakout_confirmed 全新买入、满仓替换
- **判定方式**：通过申万二级行业到一级行业的映射关系（`get_level2_parent`）
- **一级行业数据**：不受此约束（无父级行业）

### 执行顺序

每周处理顺序：**先卖后买**
1. 处理所有**确认崩盘**卖出信号
2. 处理所有**强制卖出**（ATR止损，跳过已卖出的）
3. 处理所有**假突破**卖出试探仓
4. 处理所有**接近突破**买入30%试探仓（仅有空位时）
5. 处理所有**确认突破**加仓70% / 全仓买入
- 卖出释放的资金可用于当周买入

## 执行假设

- **交易频率**：周频，每周五收盘后评估信号
- **执行价格**：信号产生当周的收盘价
- **交易成本**：无（行业指数不可直接交易，此为模拟策略）
- **滑点**：无
- **资金利用**：允许部分资金以现金形式闲置

## 绩效指标

| 指标 | 计算方式 |
|------|----------|
| 总收益率 | (期末资产 / 期初资产) - 1 |
| 年化收益率 | (1 + 总收益率)^(1/年数) - 1 |
| 最大回撤 | 期间内从峰值到谷值的最大跌幅 |
| 夏普比率 | 周收益均值 / 周收益标准差 × √52 |
| 胜率 | 盈利交易次数 / 总配对交易次数 |

## 基准对比

- **基准**：申万行业等权指数（按所选级别的全部行业计算）
- 各行业收盘价标准化为1.0（回测起始日），取均值后缩放至初始资金规模

## 已知局限

1. **不可直接交易**：申万行业指数是统计指数，不可直接买卖。实际操作需通过行业ETF或成分股组合实现
2. **无交易成本**：未考虑手续费、印花税、滑点等摩擦成本
3. **信号滞后**：Weinstein阶段判断基于34周均线，具有较大的滞后性
4. **指数编制变化**：申万行业分类在2014年和2021年经历过调整，历史回测存在"幸存者偏差"
5. **周频限制**：策略以周为单位操作，无法捕捉日内或日间的短期波动
