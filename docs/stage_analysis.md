# 阶段分析方法

基于温斯坦（Stan Weinstein）34 周均线阶段分析法，对 A 股申万行业指数（2021 版）进行趋势阶段判断。支持一级行业（31 个）和二级行业（124 个）。

## 核心方法

以 34 周简单移动平均线（MA34）为中轴，将行业趋势划分为四个阶段：

| 阶段 | 名称 | 特征 |
|------|------|------|
| Stage 1 | 熊市 | 价格持续在 MA34 下方，均线下行，反弹受压 |
| Stage 2 | 熊牛转换 | 价格围绕 MA34 反复争夺，均线走平，量能回升 |
| Stage 3 | 牛市 | 价格稳定在 MA34 上方，均线上行，回踩获支撑 |
| Stage 4 | 牛熊转换 | 价格围绕 MA34 争夺，均线由升转平，支撑失效 |

**核心策略**：买在第二阶段尾声（放量突破确认），卖在第四阶段（支撑失效确认）。

## 状态机模型

采用有限状态机（FSM）控制阶段转换，防止信号频繁跳变（Whipsaw）。只允许以下合法转换路径：

```
    ┌──────────────────────────────────────────────┐
    │                                              │
    ▼                                              │
 Stage 1 ──→ Stage 2 ──→ Stage 3 ──→ Stage 4 ──→ ┘
 (熊市)      (熊牛转换)    (牛市)      (牛熊转换)
              │  ▲                      │  ▲
              │  │                      │  │
              ▼  │                      ▼  │
           Stage 1                   Stage 3
          (底部失败)               (假跌破修复)
```

### 转换条件

| 路径 | 条件 | 说明 |
|------|------|------|
| 2 → 3 严格突破 | 价格 > MA34×(1+α) + 斜率上行 + 量比 ≥ 1.5x | 标准放量突破 |
| 2 → 3 持续性突破 | 连续 ≥ 8 周站上 MA34 + 价格 > MA34×(1+α) + 支撑守住 | 不要求放量，适用于温和上涨 |
| 4 → 1 崩盘 | 价格 < MA34×(1-α) + 斜率下行 | 确认趋势反转 |
| 4 → 3 严格修复 | 价格 > MA34×(1+α) + 斜率上行 + 量比 ≥ 1.5x | 放量确认假跌破 |
| 4 → 3 持续性恢复 | 连续 ≥ 8 周站上 MA34 + 价格 > MA34×(1+α) + 支撑守住 | 不要求放量，适用于缓慢修复 |
| 2 → 1 失败回落 | 价格 < MA34×(1-α) + 斜率下行 | 底部构筑失败 |

> α 为自适应阈值，由 ATR 动态计算（见下文）。

## ATR 自适应阈值

### 问题

固定阈值（α=5%, slope_flat=1.5%, support_tolerance=2%）对不同波动特征的行业"一刀切"。例如：

- **银行**（ATR% ~3.3%）：低波动，固定 5% 阈值过松，需要很大偏离才触发判定
- **传媒**（ATR% ~5.5%）：高波动，固定 5% 阈值过紧，正常波动即触发误判

两者波动差异近 2 倍，同一套阈值无法兼顾。

### 方案

引入 14 周 ATR（Average True Range）作为波动率基准，将关键阈值从固定常量改为逐行动态计算：

```
atr_pct = ATR14 / MA34              # 归一化波动率
adaptive_alpha = 1.0 × atr_pct      # 价格偏离阈值
adaptive_slope_flat = 0.3 × atr_pct  # 斜率走平阈值
adaptive_support_tol = 0.4 × atr_pct # 支撑/压力容忍度
```

系数来源：固定阈值 ÷ 全行业 ATR% 中位数（≈ 0.047），使中位数行业的自适应值与原固定值一致。

### 效果

| 行业 | ATR% | adaptive_alpha | 对比固定 5% |
|------|------|----------------|-------------|
| 银行 | ~3.3% | ~3.3% | 更灵敏，更早捕捉趋势变化 |
| 传媒 | ~5.5% | ~5.5% | 更宽容，减少假信号 |
| 中位数行业 | ~4.7% | ~4.7% | 与原固定阈值基本一致 |

### ATR 计算

```
TR = max(High - Low, |High - PrevClose|, |Low - PrevClose|)
ATR14 = SMA(TR, 14)
```

ATR14 在 `generate_weekly_kline()` 流程中随 MA34、MA 斜率一起计算，作为周 K 线的标准输出列。

## 参数配置

### 基础参数（固定）

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `price_position_threshold` | 5% | 价格偏离 MA34 的显著性阈值（ATR 缺失时的 fallback） |
| `slope_flat_threshold` | 1.5% | MA 斜率"走平"判定阈值（ATR 缺失时的 fallback） |
| `support_tolerance` | 2% | 支撑/压力的容忍度（ATR 缺失时的 fallback） |
| `crossover_window` | 8 周 | 穿越频率统计窗口 |
| `crossover_threshold` | 2 次 | "反复争夺"的穿越次数阈值 |
| `breakout_volume_threshold` | 1.5x | 突破时的放量确认倍数 |
| `support_window` | 4 周 | 支撑/压力确认的回看窗口 |

### ATR 自适应系数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `atr_alpha_multiplier` | 1.0 | adaptive_alpha = 系数 × atr_pct |
| `atr_slope_multiplier` | 0.3 | adaptive_slope_flat = 系数 × atr_pct |
| `atr_support_multiplier` | 0.4 | adaptive_support_tol = 系数 × atr_pct |
| `recovery_sustain_weeks` | 8 周 | 持续性恢复/突破路径要求的连续站稳周数 |
