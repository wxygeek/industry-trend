# 交易信号

系统在 Stage 2（熊牛转换）和 Stage 4（牛熊转换）中检测细粒度信号，帮助判断趋势突破或崩盘的进展。

> 以下公式中：`α` = adaptive_alpha（ATR 自适应），`β` = adaptive_slope_flat（ATR 自适应），`VolRatio` = 4 周均量 / 10 周均量，`price_pos` = (close - MA34) / MA34，`ma_slope` = MA34 的 4 周变化率。

## 利好信号（标注在 K 线下方）

### 1. 接近突破 `approaching_breakout`

底部转换期的早期积极信号，价格首次尝试站上均线。

**前置条件**：当前处于 Stage 2（熊牛转换），且此前未出现过未消耗的"接近突破"信号。

**触发条件**（全部满足）：

- `price_pos > 0` — 收盘价站上 MA34
- `ma_slope >= 0` — 均线斜率不再下行（走平或上行）
- 同时**不满足**完整突破的全部三项条件，即以下至少一项不成立：
  - `price_pos > α`（偏离不够显著）
  - `ma_slope > β`（斜率不够陡峭）
  - `VolRatio >= 1.5`（量能不足）

**含义**：价格试探性突破均线，但力度不够（量、速度、幅度至少缺一项），突破尚未确认。需关注后续能否放量跟进。

---

### 2. 确认突破 `breakout_confirmed`

牛市正式确立的确认信号。**买入信号。**

**前置条件**：上一周处于 Stage 2，本周状态机判定转入 Stage 3。

**触发条件**（满足以下任一路径即可完成 2→3 转换）：

**路径 A — 严格放量突破**（全部满足）：
- `price_pos > α` — 价格显著站上 MA34
- `ma_slope > β` — 均线明确拐头向上
- `VolRatio >= 1.5` — 成交量放大至均量 1.5 倍

**路径 B — 持续性突破**（全部满足）：
- `consecutive_above_ma >= 8` — 连续 8 周以上收盘价在 MA34 上方
- `price_pos > α` — 价格显著站上 MA34
- `support_held = True` — 近 4 周最低点守住 MA34 支撑

**路径 C — 宽松放量突破**（全部满足）：
- `bull_score > bottom_score × 1.5` — 牛市评分显著高于底部评分
- `price_pos > α` — 价格显著站上 MA34
- `ma_slope > β` — 均线拐头向上
- `VolRatio >= 1.2` — 成交量放大至均量 1.2 倍（低于严格标准）

**含义**：趋势由底部震荡正式进入上升通道。三条路径覆盖不同突破形态：爆发性放量突破、温和持续上涨、以及介于两者之间的中等强度突破。

---

### 3. 假崩盘 `breakdown_failed`

牛熊转换期的一次下跌被证明是假动作。

**前置条件**：当前处于 Stage 4，且此前已出现过"接近崩盘"信号（标记为活跃状态）。

**触发条件**：

- `price_pos > 0` — 价格重新站回 MA34 上方

**含义**：之前跌破均线被认为是"接近崩盘"，但本周价格重返均线上方，说明空头力量不足，下跌只是假动作。短期利好，但仍处于 Stage 4，需持续观察。

---

### 4. 修复回牛 `bull_recovery`

牛熊转换期结束，趋势重新回到牛市。

**前置条件**：上一周处于 Stage 4，本周状态机判定转回 Stage 3。

**触发条件**（满足以下任一路径即可完成 4→3 转换）：

**路径 A — 严格放量修复**（全部满足）：
- `price_pos > α` — 价格显著站上 MA34
- `ma_slope > β` — 均线恢复上行
- `VolRatio >= 1.5` — 放量确认

**路径 B — 持续性恢复**（全部满足）：
- `consecutive_above_ma >= 8` — 连续 8 周以上收盘价在 MA34 上方
- `price_pos > α` — 价格显著站上 MA34
- `support_held = True` — 近 4 周最低点守住支撑

**含义**：此前的牛熊转换被证伪。原本的"顶部信号"只是上升途中的正常回调或震荡，趋势恢复上行。

---

## 利空信号（标注在 K 线上方）

### 5. 接近崩盘 `approaching_breakdown`

牛熊转换期的早期危险信号，价格首次跌破均线。

**前置条件**：当前处于 Stage 4（牛熊转换），且此前未出现过未消耗的"接近崩盘"信号。

**触发条件**（全部满足）：

- `price_pos < 0` — 收盘价跌破 MA34
- `ma_slope <= 0` — 均线斜率不再上行（走平或下行）
- 同时**不满足**完整崩盘的全部两项条件，即以下至少一项不成立：
  - `price_pos < -α`（跌幅不够深）
  - `ma_slope < -β`（下行速度不够快）

**含义**：价格跌破均线支撑，但跌幅或均线下行速度尚不足以确认趋势反转。需要警惕，但崩盘未最终确认。

---

### 6. 确认崩盘 `breakdown_confirmed`

熊市正式确立的确认信号。**卖出 / 离场信号。**

**前置条件**：上一周处于 Stage 4，本周状态机判定转入 Stage 1。

**触发条件**（满足以下任一路径即可完成 4→1 转换）：

**路径 A — 标准崩盘**（全部满足）：
- `price_pos < -α` — 价格显著跌破 MA34
- `ma_slope < -β` — 均线明确拐头向下

**路径 B — 宽松崩盘**（全部满足）：
- `bear_score > top_score × 1.3` — 熊市评分显著高于牛熊转换评分
- `price_pos < -α` — 价格显著跌破 MA34

**路径 C — 硬性规则强制**（全部满足）：
- `consecutive_below_ma >= 4` — 连续 4 周收盘价在 MA34 下方
- `ma_slope < -β` — 均线下行

**含义**：趋势由顶部震荡正式进入下跌通道。路径 C 为无条件硬规则，无论前一状态是什么，连续 4 周跌破 + 斜率下行即强制进入熊市。

---

### 7. 假突破 `breakout_failed`

底部转换期的一次上攻被证明是假突破。

**前置条件**：当前处于 Stage 2，且此前已出现过"接近突破"信号（标记为活跃状态）。

**触发条件**：

- `price_pos < 0` — 价格重新跌回 MA34 下方

**含义**：之前站上均线被认为是"接近突破"，但本周价格跌回均线下方，说明多头力量不足，上攻只是假动作。短期利空，继续底部震荡。

---

### 8. 回落熊市 `bear_fallback`

底部构筑彻底失败，趋势重新进入熊市。

**前置条件**：上一周处于 Stage 2，本周状态机判定退回 Stage 1。

**触发条件**（满足以下任一路径即可完成 2→1 转换）：

**路径 A — 标准回落**（全部满足）：
- `price_pos < -α` — 价格显著跌破 MA34
- `ma_slope < -β` — 均线恢复下行

**路径 B — 硬性规则强制**（全部满足）：
- `consecutive_below_ma >= 4` — 连续 4 周收盘价在 MA34 下方
- `ma_slope < -β` — 均线下行

**含义**：此前的底部整理只是下跌中继，趋势重新恶化。Stage 2 构筑的"底部"被击穿。

---

## 信号生命周期

```text
                 Stage 2 内部                                Stage 4 内部
          ┌──────────────────────┐                    ┌──────────────────────┐
          │                      │                    │                      │
  价格站上MA34  ──→ 接近突破         │            价格跌破MA34  ──→ 接近崩盘         │
          │       │              │                    │       │              │
          │   价格跌回MA34下方       │                    │   价格站回MA34上方       │
          │       │              │                    │       │              │
          │       ▼              │                    │       ▼              │
          │     假突破            │                    │     假崩盘            │
          │                      │                    │                      │
          └──────────────────────┘                    └──────────────────────┘
                    │                                           │
       ┌────────────┼────────────┐              ┌──────────────┼──────────────┐
       ▼            ▼            ▼              ▼              ▼              ▼
   确认突破      回落熊市    继续震荡       修复回牛        确认崩盘       继续震荡
   (→ S3)       (→ S1)     (留 S2)       (→ S3)         (→ S1)        (留 S4)
```

## 信号使用建议

| 信号类型 | 信号 | 操作建议 |
|----------|------|----------|
| 预警信号 | 接近突破 / 接近崩盘 | 提示关注，不宜直接操作。可开始制定后续计划 |
| 确认信号 | 确认突破 / 确认崩盘 | 可作为买卖决策的核心参考依据 |
| 反转信号 | 假突破 / 假崩盘 | 前一次尝试失败，趋势未改变。调整预期，继续观察 |
| 回退信号 | 修复回牛 / 回落熊市 | 转换期判断被推翻，趋势恢复。重新评估持仓策略 |

## 量化指标

| 指标 | 计算方式 | 用途 |
|------|----------|------|
| 价格偏离度 | (close - MA34) / MA34 | 判断价格与均线的相对位置（阈值由 ATR 自适应） |
| MA34 斜率 | 4 周内 MA34 的变化率 | 判断均线趋势方向（走平阈值由 ATR 自适应） |
| ATR14 | 14 周真实波幅均值 | 衡量行业波动率，驱动自适应阈值 |
| 穿越频率 | 8 周内价格穿越 MA34 的次数 | 区分争夺期（>=2次）与单边期 |
| 成交量比 | 4 周均量 / 10 周均量 | 判断市场活跃度 |
| 支撑确认 | 近4周最低点 > MA34 × (1 - tolerance) | 牛市中回踩是否守住支撑（tolerance 由 ATR 自适应） |
| 压力确认 | 近4周最高点 < MA34 × (1 + tolerance) | 熊市中反弹是否被均线压制（tolerance 由 ATR 自适应） |
| 突破放量 | 成交量比 >= 1.5 | 阶段突破信号的量能确认 |
