## Context

本项目是一个全新的 Python 项目，从零搭建。核心需求是自动化跟踪A股31个申万一级行业的大周期趋势状态，基于温斯坦（Weinstein）34周均线阶段分析法，量化判断每个行业当前处于四个阶段中的哪个阶段。

通过对申万研究所官网的实际调研，已确认以下技术事实：
- 行业列表 API: `GET /institute-sw/api/index_publish/current/?page=1&page_size=50&indextype=一级行业` 返回31个行业的 code/name
- 行情下载 API: `POST /insWechatSw/swIndex/quotationexportExc` 以 `{swindexcode: "801010"}` 为参数，返回 XLS 文件
- XLS 数据包含18列：指数代码、指数名称、发布日期、开盘/最高/最低/收盘指数、成交量(亿股)、成交额(亿元)、涨跌幅(%)、换手率(%)、市盈率、市净率、均价、成交额占比、流通市值、平均流通市值、股息率
- 数据时间跨度从1999年12月至今，约6300条日K线记录/行业

31个申万一级行业（2021版）的代码和名称为固定数据，将持久化保存在本地配置中，无需每次从网页获取。

## Goals / Non-Goals

**Goals:**
- 一键采集31个行业的全量历史日K线数据，支持增量更新
- 准确将日K线聚合为周K线，计算34周MA及其斜率
- 量化实现Weinstein四阶段判断，输出每个行业的阶段编号和置信度
- 提供交互式Web仪表板，展示阶段汇总表格和周K线图表

**Non-Goals:**
- 不实现自动交易或交易信号推送
- 不做个股层面的分析，仅分析行业指数
- 不做实时行情推送，定期（每周）更新即可
- 不实现二级/三级行业分析
- 不构建复杂的用户认证/多用户系统

## Decisions

### D1: 数据采集方式 — Playwright 浏览器自动化

**选择**: 使用 Playwright（通过 playwright-mcp 或 playwright Python库）控制浏览器，直接调用申万官网的 POST API 下载 XLS 文件。

**理由**: 用户明确要求使用 Playwright 控制浏览器来爬取数据。官网的下载接口是 POST 请求返回 XLS 文件，通过浏览器环境可以自然处理 cookie/session/反爬。

**替代方案**:
- requests 直接请求 API: 可能遭遇反爬，但经测试 POST API 目前无需登录即可访问，可作为降级方案
- AKShare/Tushare 等开源数据源: 数据可能有延迟或不完整，不是直接数据源

### D2: 行业元数据 — 本地配置文件

**选择**: 将31个行业的 code 和 name 保存为项目内的静态配置文件（Python dict 或 JSON），不在每次运行时从网页获取。

**理由**: 申万一级行业分类（2021版）是稳定数据，极少变动。本地配置避免了不必要的网络请求，提高启动速度和可靠性。

### D3: 数据存储 — CSV 文件按行业分文件存储

**选择**: 每个行业一个 CSV 文件，存储在 `data/daily/` 目录下，文件名格式 `{code}_{name}.csv`。

**理由**: CSV 格式简单、可读、易于调试，pandas 读写高效。按行业分文件便于增量更新和单独检查。数据量不大（31个行业 × ~6300条 ≈ 20万条），无需数据库。

**替代方案**:
- SQLite: 查询灵活但增加依赖复杂度，对此规模数据无优势
- Parquet: 压缩率高但可读性差，不便于人工检查

### D4: 周K线聚合逻辑

**选择**: 使用 pandas resample 按自然周（周一至周五）聚合日K线数据。

**聚合规则**:
- 开盘价: 本周第一个交易日的开盘价
- 最高价: 本周所有交易日的最高价中取最大值
- 最低价: 本周所有交易日的最低价中取最小值
- 收盘价: 本周最后一个交易日的收盘价
- 成交量: 本周所有交易日成交量之和
- 成交额: 本周所有交易日成交额之和

**34周MA**: 使用收盘价的34周简单移动平均（SMA）。同时计算MA斜率（当前MA - N周前MA）/ N 来辅助阶段判断。

### D5: Weinstein 四阶段量化算法

**选择**: 综合价格与MA34的位置关系、穿越行为、偏离度和成交量特征来判断阶段。

**核心指标**:

| 指标 | 计算方式 | 用途 |
|------|---------|------|
| 价格位置 (price_position) | (close - MA34) / MA34 | 价格偏离MA的比例 |
| MA斜率 (ma_slope) | (MA34 - MA34[n周前]) / MA34[n周前] | MA趋势方向 |
| 穿越信号 (cross_signal) | close穿越MA34的方向和频率 | 判断争夺还是单边 |
| 成交量比 (volume_ratio) | 近N周均量 / 长期均量 | 量能配合程度 |

**阶段判断逻辑**:

1. **第一阶段（熊市）**: price_position 持续为负且绝对值较大，ma_slope 为负或走平，近期无有效上穿MA34，成交量萎缩
2. **第二阶段（熊牛转换）**: 价格围绕MA34反复穿越（cross频率高），ma_slope 由负转平或微正，price_position 在小幅正负间震荡，成交量逐步放大
3. **第三阶段（牛市）**: price_position 持续为正且绝对值较大，ma_slope 为正，近期无有效下穿MA34，成交量活跃
4. **第四阶段（牛熊转换）**: 价格围绕MA34反复穿越（cross频率高），ma_slope 由正转平或微负，price_position 在小幅正负间震荡，成交量不稳定

**判断流程**: 先用穿越频率区分"争夺期"（阶段2/4）和"单边期"（阶段1/3），再用MA斜率和价格位置区分具体阶段。输出阶段编号(1-4)和置信度(0-1)。

### D6: Web 框架 — Streamlit

**选择**: 使用 Streamlit 构建 Web 仪表板。

**理由**: Streamlit 是 Python 数据分析领域最流行的快速原型框架，无需前端开发经验。内置支持 plotly 交互式图表、表格组件、筛选器。部署简单（`streamlit run app.py`）。

**替代方案**:
- Dash: 更灵活但学习曲线更陡，适合复杂产品但对原型过重
- Flask + echarts: 需要大量前端代码，开发效率低
- Gradio: 更偏向ML演示，不适合数据仪表板

### D7: 可视化 — Plotly

**选择**: 使用 Plotly 绘制交互式周K线图和MA叠加线。

**理由**: Plotly 原生支持K线图（candlestick）、时间序列图表、缩放平移交互，与 Streamlit 无缝集成。

## Risks / Trade-offs

- **[申万官网反爬升级]** → 缓解：保留 API 地址和参数的配置化，便于快速适配；行业列表本地持久化减少请求；控制请求频率（每次下载间隔2-3秒）
- **[XLS文件格式变更]** → 缓解：数据解析逻辑集中在一个模块中，列名映射可配置
- **[阶段判断算法精度]** → 缓解：参数（穿越频率阈值、偏离度阈值等）可调，提供置信度评分辅助人工判断
- **[周K线边界处理]** → 缓解：节假日可能导致某周交易日不足5天，使用 pandas resample 自动处理不完整周
- **[Streamlit性能]** → 缓解：31个行业数据量不大，预计无性能瓶颈；图表按需渲染

## 项目结构

```
industry-trend/
├── config/
│   └── industries.py          # 31个行业代码+名称的静态配置
├── data/
│   └── daily/                 # 每个行业的日K CSV文件
├── src/
│   ├── scraper.py             # Playwright 数据采集模块
│   ├── kline.py               # 周K线聚合 + MA34计算
│   ├── stage_analyzer.py      # Weinstein四阶段判断算法
│   └── utils.py               # 通用工具函数
├── app.py                     # Streamlit Web仪表板入口
├── main.py                    # CLI入口：采集+分析一体化
└── requirements.txt           # Python依赖
```
